import traceback  # For displaying exceptions
import os
import logging
from log_utils import LogUtils
from datetime import datetime  # For current day and time
from datetime import date
from time import time  # For runtime of scripts

from strawberryfields.apps import data, plot, sample, clique
from strawberryfields.apps.sample import postselect
from strawberryfields.decompositions import takagi
from scipy.sparse.csgraph import laplacian
from thewalrus.samples import hafnian_sample_graph
import numpy as np
import networkx as nx
import plotly

#Loading samples generated by Generate_samples.py file
cwd='Results\\19-May-2022-(13.06.28.348660)\\'
excel_file=cwd+'test.csv'
tot_samples =np.loadtxt(excel_file,delimiter=',')
#Loading the graph from TaceAs problem
TA = data.TaceAs()
A = TA.adj
TA_graph = nx.Graph(A)
print(len(tot_samples))
histogram=np.zeros(10)
for s in tot_samples:
    sum=np.sum(s)
    histogram[int(sum)]+=1
print(histogram)

GBS_dens = []
u_dens = []
samples_GBS=postselect(tot_samples,4,4)




##Should I compare between with the TACE graph or the laplacian of TACE?
##Comparing the difference of density between the 8-nodes subgraphs generated by GBS and a uniform sampling of the graph
for s in samples_GBS:
    uniform = list(np.random.choice(24, 4, replace=False))  # generates uniform sample
    GBS_dens.append(nx.density(TA_graph.subgraph(s)))
    u_dens.append(nx.density(TA_graph.subgraph(uniform)))

print("GBS mean density = {:.4f}".format(np.mean(GBS_dens)))
print("Uniform mean density = {:.4f}".format(np.mean(u_dens)))

shrunk = [clique.shrink(s, TA_graph) for s in samples_GBS]
print(clique.is_clique(TA_graph.subgraph(shrunk[0])))
clique_sizes = [len(s) for s in shrunk]
print("First ten clique sizes = ", clique_sizes[:10])
print("Average clique size = {:.3f}".format(np.mean(clique_sizes)))
print("Maximum clique size = ", np.max(clique_sizes))
print("Minimum clique size = ", np.min(clique_sizes))

searched = [clique.search(s, TA_graph, 10) for s in shrunk]
clique_sizes = [len(s) for s in searched]
print("First two cliques = ", searched[:2])
print("Average clique size = {:.3f}".format(np.mean(clique_sizes)))

fig=plot.graph(TA_graph, searched[0])
fig.show()
